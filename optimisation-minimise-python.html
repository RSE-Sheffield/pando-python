<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Performance Profiling &amp; Optimisation (Python): Understanding Python (NumPy/Pandas)</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="icon" href="assets/images/UOSSheild_Primary_Violet_RGB.ico" sizes="any"><link rel="icon" href="assets/images/UOSSheild_Primary_Violet_RGB.svg" type="image/svg+xml"><link rel="manifest" href="site.webmanifest"><link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <a href="https://www.sheffield.ac.uk" class="external-link">
          <img alt="University of Sheffield" src="assets/images/UOSLogo_Primary_Violet_RGB.svg" class="light-only"><img alt="University of Sheffield" src="assets/images/UOSLogo_Primary_White_RGB.svg" class="dark-only"></a>

        <span class="badge text-bg-warning">
          <abbr title="This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#field-testing-alpha-stage" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-triangle" style="border-radius: 5px"></i>
              Alpha
            </a>
            <span class="visually-hidden">This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/optimisation-minimise-python.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="University of Sheffield" src="assets/images/UOSSheild_Primary_Violet_RGB.svg"></div>
    <div class="lesson-title-md">
      Performance Profiling &amp; Optimisation (Python)
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Performance Profiling &amp; Optimisation (Python)
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="registration.html">Registration Information</a></li><li><a class="dropdown-item" href="acknowledgements.html">Acknowledgements</a></li><li><a class="dropdown-item" href="ppp.html">Performant Python Patterns (Talk)</a></li><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Performance Profiling &amp; Optimisation (Python)
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 76%" class="percentage">
    76%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 76%" aria-valuenow="76" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/optimisation-minimise-python.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="profiling-introduction.html">1. Introduction to Profiling</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="profiling-functions.html">2. Function Level Profiling</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="short-break1.html">3. Break</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="profiling-lines.html">4. Line Level Profiling</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="profiling-conclusion.html">5. Profiling Conclusion</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="optimisation-introduction.html">6. Introduction to Optimisation</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="optimisation-data-structures-algorithms.html">7. Data Structures &amp; Algorithms</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="long-break1.html">8. Break</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        9. Understanding Python (NumPy/Pandas)
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#scope">Scope</a></li>
<li><a href="#built-in-functions-operators">Built-in Functions Operators</a></li>
<li><a href="#using-numpy-effectively">Using NumPy (Effectively)</a></li>
<li><a href="#using-pandas-effectively">Using Pandas (Effectively)</a></li>
<li><a href="#operating-on-rows">Operating on Rows</a></li>
<li><a href="#filter-early">Filter Early</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="optimisation-use-latest.html">10. Keep Python &amp; Packages up to Date</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="optimisation-memory.html">11. Understanding Memory</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush13">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading13">
        <a href="optimisation-conclusion.html">12. Optimisation Conclusion</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="registration.html">Registration Information</a></li><li><a href="acknowledgements.html">Acknowledgements</a></li><li><a href="ppp.html">Performant Python Patterns (Talk)</a></li><li><a href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="long-break1.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="optimisation-use-latest.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="long-break1.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Break
        </a>
        <a class="chapter-link float-end" href="optimisation-use-latest.html" rel="next">
          Next: Keep Python &amp;...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Understanding Python (NumPy/Pandas)</h1>
        <p>Last updated on 2024-03-28 |

        <a href="https://github.com/RSE-Sheffield/pando-python/edit/main/episodes/optimisation-minimise-python.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>Why are Python loops slow?</li>
<li>Why is NumPy often faster than raw Python?</li>
<li>How can processing rows of a Pandas data table be made faster?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Able to identify when Python code can be rewritten to perform
execution in the back-end.</li>
<li>Able to utilise NumPy’s vectorisation when operating on arrays of
data.</li>
<li>Able to efficiently process rows when working with data tables.</li>
</ul></div>
</div>
</div>
</div>
</div>
<p>Python is an interpreted programming language. When you execute your
<code>.py</code> file, the (default) CPython back-end compiles your
Python source code to an intermediate bytecode. This bytecode is then
interpreted in software at runtime generating instructions for the
processor as necessary. This interpretation stage, and other features of
the language, harm the performance of Python (whilst improving it’s
usability).<!-- https://jakevdp.github.io/blog/2014/05/09/why-python-is-slow/ --></p>
<p>In comparison, many languages such as C/C++ compile directly to
machine code. This allows the compiler to perform low-level
optimisations that better exploit hardware nuance to achieve fast
performance. This however comes at the cost of compiled software not
being cross-platform.</p>
<p>Whilst Python will rarely be as fast as compiled languages like
C/C++, it is possible to take advantage of the CPython back-end and
packages such as NumPy and Pandas that have been written in compiled
languages to expose this performance.</p>
<p>A simple example of this would be to perform a linear search of a
list (in the previous episode we did say this is not recommended). The
below example creates a list of 2500 integers in the inclusive-exclusive
range <code>[0, 5000)</code>. It then searches for all of the even
numbers in that range. <code>searchlistPython()</code> is implemented
manually, iterating <code>ls</code> checking each individual item in
Python code. <code>searchListC()</code> in contrast uses the
<code>in</code> operator to perform each search, which allows CPython to
implement the inner loop in it’s C back-end.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">2500</span>  <span class="co"># Number of elements in list</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">2</span>  <span class="co"># N*M == Range over which the elements span</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="kw">def</span> generateInputs():</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>    random.seed(<span class="dv">12</span>)  <span class="co"># Ensure every list is the same</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>    <span class="cf">return</span> [random.randint(<span class="dv">0</span>, <span class="bu">int</span>(N<span class="op">*</span>M)) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N)]</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>    </span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="kw">def</span> searchListPython():</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>    ls <span class="op">=</span> generateInputs()</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>    ct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">int</span>(N<span class="op">*</span>M), M):</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(ls)):</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>            <span class="cf">if</span> ls[j] <span class="op">==</span> i:</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>                ct <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="kw">def</span> searchListC():</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>    ls <span class="op">=</span> generateInputs()</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>    ct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">int</span>(N<span class="op">*</span>M), M):</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>        <span class="cf">if</span> i <span class="kw">in</span> ls:</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>            ct <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>gen_time <span class="op">=</span> timeit(generateInputs, number<span class="op">=</span>repeats)</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"searchListPython: </span><span class="sc">{</span>timeit(searchListPython, number<span class="op">=</span>repeats)<span class="op">-</span>gen_time<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"searchListC: </span><span class="sc">{</span>timeit(searchListC, number<span class="op">=</span>repeats)<span class="op">-</span>gen_time<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>This results in the manual Python implementation being 5x slower,
doing the exact same operation!</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>searchListPython: 152.15ms
searchListC: 28.43ms</code></pre>
</div>
<p>An easy approach to follow is that if two blocks of code do the same
operation, the one that contains less Python is probably faster. This
won’t apply if you’re using 3rd party packages written purely in Python
though.</p>
<div id="python-bytecode" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="python-bytecode" class="callout-inner">
<h3 class="callout-title">Python bytecode</h3>
<div class="callout-content">
<p>You can use <code>dis</code> to view the bytecode generated by
Python, the amount of byte-code more strongly correlates with how much
code is being executed by the Python interpreter. However, this still
does not account for whether functions called are implemented using
Python or C.</p>
<p>The pure Python search compiles to 82 lines of byte-code.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> dis</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="kw">def</span> searchListPython():</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    ls <span class="op">=</span> generateInputs()</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>    ct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">int</span>(N<span class="op">*</span>M), M):</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(ls)):</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>            <span class="cf">if</span> ls[j] <span class="op">==</span> i:</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>                ct <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>dis.dis(searchListPython)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> 11           0 LOAD_GLOBAL              0 (generateInputs)
              2 CALL_FUNCTION            0
              4 STORE_FAST               0 (ls)

 12           6 LOAD_CONST               1 (0)
              8 STORE_FAST               1 (ct)

 13          10 LOAD_GLOBAL              1 (range)
             12 LOAD_CONST               1 (0)
             14 LOAD_GLOBAL              2 (int)
             16 LOAD_GLOBAL              3 (N)
             18 LOAD_GLOBAL              4 (M)
             20 BINARY_MULTIPLY
             22 CALL_FUNCTION            1
             24 LOAD_GLOBAL              4 (M)
             26 CALL_FUNCTION            3
             28 GET_ITER
        &gt;&gt;   30 FOR_ITER                24 (to 80)
             32 STORE_FAST               2 (i)

 14          34 LOAD_GLOBAL              1 (range)
             36 LOAD_CONST               1 (0)
             38 LOAD_GLOBAL              5 (len)
             40 LOAD_FAST                0 (ls)
             42 CALL_FUNCTION            1
             44 CALL_FUNCTION            2
             46 GET_ITER
        &gt;&gt;   48 FOR_ITER                14 (to 78)
             50 STORE_FAST               3 (j)

 15          52 LOAD_FAST                0 (ls)
             54 LOAD_FAST                3 (j)
             56 BINARY_SUBSCR
             58 LOAD_FAST                2 (i)
             60 COMPARE_OP               2 (==)
             62 POP_JUMP_IF_FALSE       38 (to 76)

 16          64 LOAD_FAST                1 (ct)
             66 LOAD_CONST               2 (1)
             68 INPLACE_ADD
             70 STORE_FAST               1 (ct)

 17          72 POP_TOP
             74 JUMP_FORWARD             1 (to 78)

 15     &gt;&gt;   76 JUMP_ABSOLUTE           24 (to 48)
        &gt;&gt;   78 JUMP_ABSOLUTE           15 (to 30)

 13     &gt;&gt;   80 LOAD_CONST               0 (None)
             82 RETURN_VALUE</code></pre>
</div>
<p>Whereas the <code>in</code> variant only compiles to 54.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="im">import</span> dis</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="kw">def</span> searchListC():</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    ls <span class="op">=</span> generateInputs()</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    ct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">int</span>(N<span class="op">*</span>M), M):</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>        <span class="cf">if</span> i <span class="kw">in</span> ls:</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>            ct <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>dis.dis(searchListC)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  4           0 LOAD_GLOBAL              0 (generateInputs)
              2 CALL_FUNCTION            0
              4 STORE_FAST               0 (ls)

  5           6 LOAD_CONST               1 (0)
              8 STORE_FAST               1 (ct)

  6          10 LOAD_GLOBAL              1 (range)
             12 LOAD_CONST               1 (0)
             14 LOAD_GLOBAL              2 (int)
             16 LOAD_GLOBAL              3 (N)
             18 LOAD_GLOBAL              4 (M)
             20 BINARY_MULTIPLY
             22 CALL_FUNCTION            1
             24 LOAD_GLOBAL              4 (M)
             26 CALL_FUNCTION            3
             28 GET_ITER
        &gt;&gt;   30 FOR_ITER                10 (to 52)
             32 STORE_FAST               2 (i)

  7          34 LOAD_FAST                2 (i)
             36 LOAD_FAST                0 (ls)
             38 CONTAINS_OP              0
             40 POP_JUMP_IF_FALSE       25 (to 50)

  8          42 LOAD_FAST                1 (ct)
             44 LOAD_CONST               2 (1)
             46 INPLACE_ADD
             48 STORE_FAST               1 (ct)
        &gt;&gt;   50 JUMP_ABSOLUTE           15 (to 30)

  6     &gt;&gt;   52 LOAD_CONST               0 (None)
             54 RETURN_VALUE</code></pre>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="scope">Scope<a class="anchor" aria-label="anchor" href="#scope"></a></h2>
<hr class="half-width"><p>When Python executes your code, it has to find the variables and
functions that you’re using.</p>
<p>This adds an additional cost to accessing variables and calling
functions in Python, which isn’t typically seen in compiled
languages.</p>
<p>In particular, it will first check whether the variable or functions
has been declared within the current function (local scope), if it can’t
find it there it will check whether it has been declared in the file
(global scope) after which it may even check whether it’s from an
imported package.</p>
<p>These are not implicitly cached, therefore repeated accesses to
variables and functions, will repeat these checks.</p>
<p>The implication, is that as local scope variables and functions are
checked first, they will be faster to use.</p>
<p>If you’re only accessing a variable once or twice that’s nothing to
worry about, this is a relatively small cost. But if a variable or
functions is being accessed regularly, such as within a loop, the impact
may become visible.</p>
<p>The below example provides a small demonstration of this in
practice.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PY<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode py" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">1000000</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="kw">def</span> test_list_global():</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    t <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>        <span class="cf">if</span> t <span class="op">&gt;</span> N:</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>        t <span class="op">+=</span> i</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>        </span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="kw">def</span> test_list_local():</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>    t <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>    N_local <span class="op">=</span> N</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N_local):</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>        <span class="cf">if</span> t <span class="op">&gt;</span> N_local:</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>        t <span class="op">+=</span> i</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>        </span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Global Scope: </span><span class="sc">{</span>timeit(test_list_global, number<span class="op">=</span>repeats)<span class="sc">:.5f}</span><span class="ss">ms"</span>)</span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Local Scope: </span><span class="sc">{</span>timeit(test_list_local, number<span class="op">=</span>repeats)<span class="sc">:.5f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>This is only a trivial example, whereby <code>N</code> has been
copied to the local scope <code>N_local</code>, but local scope is about
20% faster than global scope!</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Global Scope: 0.06416ms
Local Scope: 0.05391ms</code></pre>
</div>
<p>Consider copying highly accessed variables into local scope, you can
always copy them back to global scope before you return from a
function.</p>
<p>Copying functions to local scope works much the same as variables,
e.g.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PY<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode py" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="kw">def</span> my_function():</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>    uniform_local <span class="op">=</span> np.random.uniform</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>    </span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10000</span>):</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>        t <span class="op">=</span> uniform_local()</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="built-in-functions-operators">Built-in Functions Operators<a class="anchor" aria-label="anchor" href="#built-in-functions-operators"></a></h2>
<hr class="half-width"><p>In order to take advantage of offloading computation to the CPython
back-end it’s necessary to be aware of what functionality is present.
Those available without importing packages are considered <a href="https://docs.python.org/3/library/functions.html" class="external-link">built-in</a>
functions.</p>
<p>Built-in functions are typically implemented in the CPython back-end,
so their performance benefits from bypassing the Python interpreter.</p>
<p>In particular, those which are passed an <code>iterable</code>
(e.g. lists) are likely to provide the greatest benefits to performance.
The Python documentation provides equivalent Python code for many of
these cases</p>
<ul><li>
<a href="https://docs.python.org/3/library/functions.html#all" class="external-link"><code>all()</code></a>:
boolean and of all items</li>
<li>
<a href="https://docs.python.org/3/library/functions.html#all" class="external-link"><code>any()</code></a>:
boolean or of all items</li>
<li>
<a href="https://docs.python.org/3/library/functions.html#max" class="external-link"><code>max()</code></a>:
Return the maximum item</li>
<li>
<a href="https://docs.python.org/3/library/functions.html#min" class="external-link"><code>min()</code></a>:
Return the minimum item</li>
<li>
<a href="https://docs.python.org/3/library/functions.html#sum" class="external-link"><code>sum()</code></a>:
Return the sum of all items</li>
</ul><!-- todo exercise/s where pure-python must be converted to use one of the above fns. --><div id="callout2" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>The built-in functions <a href="https://docs.python.org/3/library/functions.html#filter" class="external-link"><code>filter()</code></a>
and <a href="https://docs.python.org/3/library/functions.html#map" class="external-link"><code>map()</code></a>
can be used for processing iterables However list-comprehension is
likely to be more performant.</p>
<!-- Would this benefit from an example? -->
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="using-numpy-effectively">Using NumPy (Effectively)<a class="anchor" aria-label="anchor" href="#using-numpy-effectively"></a></h2>
<hr class="half-width"><p><a href="https://numpy.org/" class="external-link">NumPy</a> is a commonly used package for
scientific computing, which provides a wide variety of methods.</p>
<p>It adds restriction via it’s own <a href="https://numpy.org/doc/stable/user/basics.types.html" class="external-link">basic numeric
types</a>, and static arrays to enable even greater performance than
that of core Python. However if these restrictions are ignored, the
performance can become significantly worse.</p>
<div class="section level3">
<h3 id="arrays">Arrays<a class="anchor" aria-label="anchor" href="#arrays"></a></h3>
<p>NumPy’s arrays (not to be confused with the core Python
<code>array</code> package) are static arrays. Unlike core Python’s
lists, they do not dynamically resize. Therefore if you wish to append
to a NumPy array, you must call <code>resize()</code> first. If you
treat this like <code>append()</code> for a Python list, resizing for
each individual append you will be performing significantly more copies
and memory allocations than a Python list.</p>
<p>The below example sees lists and arrays constructed from
<code>range(100000)</code>.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">100000</span>  <span class="co"># Number of elements in list/array</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="kw">def</span> list_append():</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>    ls <span class="op">=</span> []</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>        ls.append(i)</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="kw">def</span> array_resize():</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>    ar <span class="op">=</span> numpy.zeros(<span class="dv">1</span>)</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, N):</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>        ar.resize(i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>        ar[i] <span class="op">=</span> i</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>        </span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"list_append: </span><span class="sc">{</span>timeit(list_append, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"array_resize: </span><span class="sc">{</span>timeit(array_resize, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>Resizing a NumPy array is 5.2x slower than a list, probably 10x
slower than list comprehension.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>list_append: 3.50ms
array_resize: 18.04ms</code></pre>
</div>
<p>Another difference, is that NumPy arrays typically require all data
to be the same type (and a NumPy type). This enables more efficient
access to elements, as they all exist contiguously in memory. In
contrast, elements within Python lists can be of any type so the list
always stores a pointer to where the element actually exists in memory,
rather than the actual element. This has the side effect that if you are
converting back and forth between Python lists and NumPy arrays, there
is an additional overhead as it’s not as simple as copying a single
block of memory.</p>
<div id="callout3" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>If you construct a NumPy array from a list containing a complex
object, it will store your data as Python types and you won’t be able to
take advantage of NumPy’s optimisations.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="op">&gt;</span>python</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> import <span class="ex">numpy</span> as np</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> a <span class="ex">=</span> np.array<span class="er">(</span><span class="ex">[0.5,</span> 5]<span class="kw">)</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">a</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'numpy.float64'</span><span class="op">&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">a</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'numpy.float64'</span><span class="op">&gt;</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> b <span class="ex">=</span> np.array<span class="er">(</span><span class="ex">[0.5,</span> 5,{<span class="st">"foo"</span>:5}]<span class="kw">)</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">b</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'float'</span><span class="op">&gt;</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">b</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'int'</span><span class="op">&gt;</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">b</span><span class="op">[</span><span class="dv">2</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'dict'</span><span class="op">&gt;</span></span></code></pre>
</div>
</div>
</div>
</div>
<p>The below example demonstrates the overhead of mixing Python lists
and NumPy functions.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Python list, numpy.random.choice()</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="op">&gt;</span>python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ls = list(range(10000))"</span> <span class="st">"numpy.random.choice(ls)"</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="ex">1000</span> loops, best of 5: 267 usec per loop</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="co"># NumPy array, numpy.random.choice()</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="op">&gt;</span>python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ar = numpy.arange(10000)"</span> <span class="st">"numpy.random.choice(ar)"</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="ex">50000</span> loops, best of 5: 4.06 usec per loop</span></code></pre>
</div>
<p>Passing a Python list to <code>numpy.random.choice()</code> is 65.6x
slower than passing a NumPy array. This is the additional overhead of
converting the list to an array. If this function were called multiple
times, it would make sense to transform the list to an array before
calling the function so that overhead is only paid once.</p>
<div id="callout4" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Python list, Manually select 1 item</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="op">&gt;</span>python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ls = list(range(10000))"</span> <span class="st">"ls[numpy.random.randint(len(ls))]"</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="ex">200000</span> loops, best of 5: 1.19 usec per loop</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="co"># NumPy array, Manually select 1 item</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="op">&gt;</span>python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ar = numpy.arange(10000)"</span> <span class="st">"ar[numpy.random.randint(len(ar))]"</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="ex">200000</span> loops, best of 5: 1.22 usec per loop</span></code></pre>
</div>
<p>Regardless, for this simple application of
<code>numpy.random.choice()</code>, merely using
<code>numpy.random.randint(len())</code> is around 4x faster regardless
whether a Python list or NumPy array is used.</p>
<p>With <code>numpy.random.choice()</code> being such a general function
(it has many possible parameters), there is significant internal
branching. If you don’t require this advanced functionality and are
calling a function regularly, it can be worthwhile considering using a
more limited function.</p>
<p>There is however a trade-off, using
<code>numpy.random.choice()</code> can be clearer to someone reading
your code, and is more difficult to use incorrectly.</p>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="vectorisation">Vectorisation<a class="anchor" aria-label="anchor" href="#vectorisation"></a></h3>
<p>The manner by which NumPy stores data in arrays enables it’s
functions to utilise vectorisation, whereby the processor executes one
instruction across multiple variables simultaneously, for every
mathematical operation between arrays.</p>
<p>Earlier in this episode it was demonstrated that using core Python
methods over a list, will outperform a loop performing the same
calculation faster. The below example takes this a step further by
demonstrating the calculation of dot product.</p>
<!-- Inspired by High Performance Python Chapter 6 example
Added python sum array, skipped a couple of others-->
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">1000000</span>  <span class="co"># Number of elements in list</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>gen_list <span class="op">=</span> <span class="ss">f"ls = list(range(</span><span class="sc">{</span>N<span class="sc">}</span><span class="ss">))"</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>gen_array <span class="op">=</span> <span class="ss">f"import numpy;ar = numpy.arange(</span><span class="sc">{</span>N<span class="sc">}</span><span class="ss">, dtype=numpy.int64)"</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>py_sum_ls <span class="op">=</span> <span class="st">"sum([i*i for i in ls])"</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>py_sum_ar <span class="op">=</span> <span class="st">"sum(ar*ar)"</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>np_sum_ar <span class="op">=</span> <span class="st">"numpy.sum(ar*ar)"</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>np_dot_ar <span class="op">=</span> <span class="st">"numpy.dot(ar, ar)"</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"python_sum_list: </span><span class="sc">{</span>timeit(py_sum_ls, setup<span class="op">=</span>gen_list, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"python_sum_array: </span><span class="sc">{</span>timeit(py_sum_ar, setup<span class="op">=</span>gen_array, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"numpy_sum_array: </span><span class="sc">{</span>timeit(np_sum_ar, setup<span class="op">=</span>gen_array, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"numpy_dot_array: </span><span class="sc">{</span>timeit(np_dot_ar, setup<span class="op">=</span>gen_array, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<ul><li>
<code>python_sum_list</code> uses list comprehension to perform the
multiplication, followed by the Python core <code>sum()</code>. This
comes out at 46.93ms</li>
<li>
<code>python_sum_array</code> instead directly multiplies the two
arrays, taking advantage of NumPy’s vectorisation. But uses the core
Python <code>sum()</code>, this comes in slightly faster at
33.26ms.</li>
<li>
<code>numpy_sum_array</code> again takes advantage of NumPy’s
vectorisation for the multiplication, and additionally uses NumPy’s
<code>sum()</code> implementation. These two rounds of vectorisation
provide a much faster 1.44ms completion.</li>
<li>
<code>numpy_dot_array</code> instead uses NumPy’s <code>dot()</code>
to calculate the dot product in a single operation. This comes out the
fastest at 0.29ms, 162x faster than <code>python_sum_list</code>.</li>
</ul><div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>python_sum_list: 46.93ms
python_sum_array: 33.26ms
numpy_sum_array: 1.44ms
numpy_dot_array: 0.29ms</code></pre>
</div>
<div id="parallel-numpy" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="parallel-numpy" class="callout-inner">
<h3 class="callout-title">Parallel NumPy</h3>
<div class="callout-content">
<!-- https://superfastpython.com/multithreaded-numpy-functions/ -->
<p>NumPy can sometimes take advantage of auto parallelisation,
particularly on HPC systems.</p>
<p>A small number of functions are backed by BLAS and LAPACK, enabling
even greater speedup.</p>
<p>The <a href="https://numpy.org/doc/stable/reference/routines.linalg.html" class="external-link">supported
functions</a> mostly correspond to linear algebra operations.</p>
<p>The auto-parallelisation of these functions is hardware dependant, so
you won’t always automatically get the additional benefit of
parallelisation. However, HPC systems should be primed to take
advantage, so try increasing the number of cores you request when
submitting your jobs and see if it improves the performance.</p>
<p><em>This might be why <code>numpy_dot_array</code> is that much
faster than <code>numpy_sum_array</code> in the previous
example!</em></p>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="vectorize"><code>vectorize()</code><a class="anchor" aria-label="anchor" href="#vectorize"></a></h3>
<p>Python’s <code>map()</code> was introduced earlier, for applying a
function to all elements within a list. NumPy provides
<code>vectorize()</code> an equivalent for operating over it’s
arrays.</p>
<p>This doesn’t actually make use of processor-level vectorisation, from
the <a href="https://numpy.org/doc/stable/reference/generated/numpy.vectorize.html" class="external-link">documentation</a>:</p>
<blockquote>
<p>The <code>vectorize</code> function is provided primarily for
convenience, not for performance. The implementation is essentially a
for loop.</p>
</blockquote>
<p>The below example demonstrates how the performance of
<code>vectorize()</code> is only marginally faster than
<code>map()</code>.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">100000</span>  <span class="co"># Number of elements in list/array</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="kw">def</span> genArray():</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    <span class="cf">return</span> numpy.arange(N)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="kw">def</span> plus_one(x):</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>    </span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="kw">def</span> python_map():</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>    ar <span class="op">=</span> genArray()</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">map</span>(plus_one, ar))</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="kw">def</span> numpy_vectorize():</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>    ar <span class="op">=</span> genArray()</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>    <span class="cf">return</span> numpy.vectorize(plus_one)(ar)</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>gentime <span class="op">=</span> timeit(genArray, number<span class="op">=</span>repeats)</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"python_map: </span><span class="sc">{</span>timeit(python_map, number<span class="op">=</span>repeats)<span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"numpy_vectorize: </span><span class="sc">{</span>timeit(numpy_vectorize, number<span class="op">=</span>repeats)<span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>python_map: 7.94ms
numpy_vectorize: 7.80ms</code></pre>
</div>
</div>
</section><section><h2 class="section-heading" id="using-pandas-effectively">Using Pandas (Effectively)<a class="anchor" aria-label="anchor" href="#using-pandas-effectively"></a></h2>
<hr class="half-width"><p><a href="https://pandas.pydata.org/" class="external-link">Pandas</a> is the most common
Python package used for scientific computing when working with tabular
data akin to spreadsheets (DataFrames).</p>
<p>Similar to NumPy, Pandas enables greater performance than pure Python
implementations when used correctly, however incorrect usage can
actively harm performance.</p>
</section><section><h2 class="section-heading" id="operating-on-rows">Operating on Rows<a class="anchor" aria-label="anchor" href="#operating-on-rows"></a></h2>
<hr class="half-width"><p>Pandas’ methods by default operate on columns. Each column or series
can be thought of as a NumPy array, highly suitable for
vectorisation.</p>
<p>Following the theme of this episode, iterating over the rows of a
data frame using a <code>for</code> loop is not advised. The pythonic
iteration will be slower than other approaches.</p>
<p>Pandas allows it’s own methods to be applied to rows in many cases by
passing <code>axis=1</code>, where available these functions should be
preferred over manual loops. Where you can’t find a suitable method,
<code>apply()</code> can be used, which is similar to
<code>map()</code>/<code>vectorize()</code>, to apply your own function
to rows.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="im">import</span> pandas</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">100000</span>  <span class="co"># Number of rows in DataFrame</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="kw">def</span> genDataFrame():</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>    numpy.random.seed(<span class="dv">12</span>)  <span class="co"># Ensure each dataframe is identical</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>    <span class="cf">return</span> pandas.DataFrame(</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>    {</span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>        <span class="st">"f_vertical"</span>: numpy.random.random(size<span class="op">=</span>N),</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>        <span class="st">"f_horizontal"</span>: numpy.random.random(size<span class="op">=</span>N),</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>        <span class="co"># todo some spurious columns</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>    })</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a><span class="kw">def</span> pythagoras(row):</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>    <span class="cf">return</span> (row[<span class="st">"f_vertical"</span>]<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> row[<span class="st">"f_horizontal"</span>]<span class="op">**</span><span class="dv">2</span>)<span class="op">**</span><span class="fl">0.5</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>    </span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a><span class="kw">def</span> for_range():</span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>    rtn <span class="op">=</span> []</span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a>    <span class="cf">for</span> row_idx <span class="kw">in</span> <span class="bu">range</span>(df.shape[<span class="dv">0</span>]):</span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a>        row <span class="op">=</span> df.iloc[row_idx]</span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a>        rtn.append(pythagoras(row))</span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a>    <span class="cf">return</span> pandas.Series(rtn)</span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a><span class="kw">def</span> for_iterrows():</span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a>    rtn <span class="op">=</span> []</span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a>    <span class="cf">for</span> row_idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a>        rtn.append(pythagoras(row))</span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a>    <span class="cf">return</span> pandas.Series(rtn)</span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a>    </span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a><span class="kw">def</span> pandas_apply():</span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a>    <span class="cf">return</span> df.<span class="bu">apply</span>(pythagoras, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a>gentime <span class="op">=</span> timeit(genDataFrame, number<span class="op">=</span>repeats)</span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"for_range: </span><span class="sc">{</span>timeit(for_range, number<span class="op">=</span>repeats)<span class="op">*</span><span class="dv">10</span><span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"for_iterrows: </span><span class="sc">{</span>timeit(for_iterrows, number<span class="op">=</span>repeats)<span class="op">*</span><span class="dv">10</span><span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"pandas_apply: </span><span class="sc">{</span>timeit(pandas_apply, number<span class="op">=</span>repeats)<span class="op">*</span><span class="dv">10</span><span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p><code>apply()</code> is 3x faster than the two <code>for</code>
approaches, as it avoids the Python <code>for</code> loop.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>for_range: 1582.47ms
for_iterrows: 1677.14ms
pandas_apply: 390.49ms</code></pre>
</div>
<p>However, rows don’t exist in memory as arrays (columns do!), so
<code>apply()</code> does not take advantage of NumPys vectorisation.
You may be able to go a step further and avoid explicitly operating on
rows entirely by passing only the required columns to NumPy.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="kw">def</span> vectorize():</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>    <span class="cf">return</span> pandas.Series(numpy.sqrt(numpy.square(df[<span class="st">"f_vertical"</span>]) <span class="op">+</span> numpy.square(df[<span class="st">"f_horizontal"</span>])))</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>    </span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"vectorize: </span><span class="sc">{</span>timeit(vectorize, number<span class="op">=</span>repeats)<span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>264x faster than <code>apply()</code>, 1000x faster than
<code>for</code> <code>iterrows()</code>!</p>
<pre><code>vectorize: 1.48ms</code></pre>
<p>It won’t always be possible to take full advantage of vectorisation,
for example you may have conditional logic.</p>
<p>An alternate approach is converting your dataframe to a Python
dictionary using <code>to_dict(orient='index')</code>. This creates a
nested dictionary, where each row of the outer dictionary is an internal
dictionary. This can then be processed via list-comprehension:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="kw">def</span> to_dict():</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>    df_as_dict <span class="op">=</span> df.to_dict(orient<span class="op">=</span><span class="st">'index'</span>)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>    <span class="cf">return</span> pandas.Series([(r[<span class="st">'f_vertical'</span>]<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> r[<span class="st">'f_horizontal'</span>]<span class="op">**</span><span class="dv">2</span>)<span class="op">**</span><span class="fl">0.5</span> <span class="cf">for</span> r <span class="kw">in</span> df_as_dict.values()])</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"to_dict: </span><span class="sc">{</span>timeit(to_dict, number<span class="op">=</span>repeats)<span class="op">*</span><span class="dv">10</span><span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>Whilst still nearly 100x slower than pure vectorisation, it’s twice
as fast as <code>apply()</code>.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="ex">to_dict:</span> 131.15ms</span></code></pre>
</div>
<p>This is because indexing into Pandas’ <code>Series</code> (rows) is
significantly slower than a Python dictionary. There is a slight
overhead to creating the dictionary (40ms in this example), however the
stark difference in access speed is more than enough to overcome that
cost for any large dataframe.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pandas</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">100000</span>  <span class="co"># Number of rows in DataFrame</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="kw">def</span> genInput():</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>    s <span class="op">=</span> pandas.Series({<span class="st">'a'</span> : <span class="dv">1</span>, <span class="st">'b'</span> : <span class="dv">2</span>})</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>    d <span class="op">=</span> {<span class="st">'a'</span> : <span class="dv">1</span>, <span class="st">'b'</span> : <span class="dv">2</span>}</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>    <span class="cf">return</span> s, d</span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="kw">def</span> series():</span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>    s, _ <span class="op">=</span> genInput()</span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>        y <span class="op">=</span> s[<span class="st">'a'</span>] <span class="op">*</span> s[<span class="st">'b'</span>]</span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a><span class="kw">def</span> dictionary():</span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>    _, d <span class="op">=</span> genInput()</span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>        y <span class="op">=</span> d[<span class="st">'a'</span>] <span class="op">*</span> d[<span class="st">'b'</span>]</span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"series: </span><span class="sc">{</span>timeit(series, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"dictionary: </span><span class="sc">{</span>timeit(dictionary, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>65x slower!</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>series: 237.25ms
dictionary: 3.63ms</code></pre>
</div>
</section><section><h2 class="section-heading" id="filter-early">Filter Early<a class="anchor" aria-label="anchor" href="#filter-early"></a></h2>
<hr class="half-width"><p>If you can filter your rows before processing, rather than after, you
may significantly reduce the amount of processing and memory used.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul><li>Python is an interpreted language, this adds an additional overhead
at runtime to the execution of Python code. Many core Python and NumPy
functions are implemented in faster C/C++, free from this overhead.</li>
<li>NumPy can take advantage of vectorisation to process arrays, which
can greatly improve performance.</li>
<li>Pandas’ data tables store columns as arrays, therefore operations
applied to columns can take advantage of NumPys vectorisation.</li>
</ul></div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="long-break1.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="optimisation-use-latest.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="long-break1.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Break
        </a>
        <a class="chapter-link float-end" href="optimisation-use-latest.html" rel="next">
          Next: Keep Python &amp;...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-2">
        <a href="https://docs.hpc.shef.ac.uk/en/latest/stanage/index.html" class="external-link">
          <img alt="Stanage HPC" src="https://docs.hpc.shef.ac.uk/en/latest/_images/Stanage_Black.png" style="width: 100%;" class="dark-invert"></a>
        <p><a href="https://sites.google.com/sheffield.ac.uk/research-training/research-training" class="external-link">Research Computing Training Home</a></p>
			</div>
			<div class="col-md-5">
        <p>Lesson developed by <a href="https://rse.shef.ac.uk" class="external-link">RSE</a> &amp; <a href="https://www.sheffield.ac.uk/it-services/research" class="external-link">RIT</a></p>
        <p>

          <a href="https://github.com/RSE-Sheffield/pando-python/edit/main/episodes/optimisation-minimise-python.md" class="external-link">Edit on GitHub</a>


        | <a href="https://github.com/RSE-Sheffield/pando-python/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/RSE-Sheffield/pando-python/" class="external-link">Source</a>
        </p>
		<p>
          <a href="https://github.com/RSE-Sheffield/pando-python/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:robert.chisholm@sheffield.ac.uk">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a> | <a href="CODE_OF_CONDUCT.html">Code of Conduct</a>
        </p>
		</div>
		<div class="col-md-5">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>


        <!--<p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY 4.0</a> by <a href="https://carpentries.org/">The Carpentries</a></p>-->
        <!--<p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11">sandpaper (0.16.11)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9">pegboard (0.7.9)</a>, and <a href="https://github.com/RSE-Sheffield/uos-varnish/tree/main">varnish (1.0.4)</a></p>-->
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11" class="external-link">sandpaper (0.16.11)</a>,
        <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>,
      and <a href="https://github.com/RSE-Sheffield/uos-varnish/tree/main" class="external-link">varnish (1.0.4) [UoS fork]</a>.</p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://rse.shef.ac.uk/pando-python/optimisation-minimise-python.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "python, profiling, optimisation, data structures, algorithms",
  "name": "Understanding Python (NumPy/Pandas)",
  "creativeWorkStatus": "active",
  "url": "https://rse.shef.ac.uk/pando-python/optimisation-minimise-python.html",
  "identifier": "https://rse.shef.ac.uk/pando-python/optimisation-minimise-python.html",
  "dateCreated": "2024-02-01",
  "dateModified": "2024-03-28",
  "datePublished": "2025-03-09"
}

  </script><script>
		feather.replace();
	</script><script defer src="https://cloud.umami.is/script.js" data-website-id="95b3ca57-3bd9-47b0-b1ca-fe819ef65c80"></script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

