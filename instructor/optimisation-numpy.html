<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Performance Profiling &amp; Optimisation (Python): Using Scientific Python Packages (NumPy, Pandas and more)</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" href="../assets/images/UOSSheild_Primary_Violet_RGB.ico" sizes="any"><link rel="icon" href="../assets/images/UOSSheild_Primary_Violet_RGB.svg" type="image/svg+xml"><link rel="manifest" href="../site.webmanifest"><link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <a href="https://www.sheffield.ac.uk" class="external-link">
          <img alt="University of Sheffield" src="../assets/images/UOSLogo_Primary_Violet_RGB.svg" class="light-only"><img alt="University of Sheffield" src="../assets/images/UOSLogo_Primary_White_RGB.svg" class="dark-only"></a>

        <span class="badge text-bg-warning">
          <abbr title="This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#field-testing-alpha-stage" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-triangle" style="border-radius: 5px"></i>
              Alpha
            </a>
            <span class="visually-hidden">This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../optimisation-numpy.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="University of Sheffield" src="../assets/images/UOSSheild_Primary_Violet_RGB.svg"></div>
    <div class="lesson-title-md">
      Performance Profiling &amp; Optimisation (Python)
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Performance Profiling &amp; Optimisation (Python)
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="registration.html">Registration Information</a></li><li><a class="dropdown-item" href="acknowledgements.html">Acknowledgements</a></li><li><a class="dropdown-item" href="ppp.html">Performant Python Patterns (Talk)</a></li><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Performance Profiling &amp; Optimisation (Python)
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 77%" class="percentage">
    77%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 77%" aria-valuenow="77" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../optimisation-numpy.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="profiling-introduction.html">1. Introduction to Profiling</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="profiling-functions.html">2. Function Level Profiling</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="short-break1.html">3. Break</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="profiling-lines.html">4. Line Level Profiling</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="profiling-conclusion.html">5. Profiling Conclusion</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="optimisation-introduction.html">6. Introduction to Optimisation</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="optimisation-using-python.html">7. Using Python Language Features and the Standard Library</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="optimisation-data-structures-algorithms.html">8. Data Structures &amp; Algorithms</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="long-break1.html">9. Break</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        10. Using Scientific Python Packages (NumPy, Pandas and more)
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#using-numpy-effectively">Using NumPy (Effectively)</a></li>
<li><a href="#other-libraries-that-use-numpy">Other Libraries That Use NumPy</a></li>
<li><a href="#using-pandas-effectively">Using Pandas (Effectively)</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="optimisation-use-latest.html">11. Keep Python &amp; Packages up to Date</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush13">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading13">
        <a href="optimisation-memory.html">12. Understanding Memory</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush14">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading14">
        <a href="optimisation-conclusion.html">13. Optimisation Conclusion</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="registration.html">Registration Information</a></li><li><a class="dropdown-item" href="acknowledgements.html">Acknowledgements</a></li><li><a class="dropdown-item" href="ppp.html">Performant Python Patterns (Talk)</a></li><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/long-break1.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/optimisation-use-latest.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/long-break1.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Break
        </a>
        <a class="chapter-link float-end" href="../instructor/optimisation-use-latest.html" rel="next">
          Next: Keep Python &amp;...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Using Scientific Python Packages (NumPy, Pandas and more)</h1>
        <p>Last updated on 2025-03-12 |

        <a href="https://github.com/RSE-Sheffield/pando-python/edit/main/episodes/optimisation-numpy.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 30 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>Why is NumPy often faster than raw Python?</li>
<li>How can processing rows of a Pandas data table be made faster?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Able to utilise NumPy’s vectorisation when operating on arrays of
data.</li>
<li>Able to efficiently process rows when working with data tables.</li>
</ul></div>
</div>
</div>
</div>
</div>
<p>Earlier, we saw that built-in Python functions, like
<code>sum()</code>, are often faster than manually looping over a list.
This is because those high-level functions are able to do most of the
work in the C backend.</p>
<p>Packages like NumPy and Pandas work similarly: They have been written
in compiled languages to expose this performance across a wide range of
scientific workloads.</p>
<section><h2 class="section-heading" id="using-numpy-effectively">Using NumPy (Effectively)<a class="anchor" aria-label="anchor" href="#using-numpy-effectively"></a></h2>
<hr class="half-width"><p><a href="https://numpy.org/" class="external-link">NumPy</a> is a commonly used package for
scientific computing, which provides a wide variety of methods.</p>
<p>It adds restriction via its own <a href="https://numpy.org/doc/stable/user/basics.types.html" class="external-link">basic numeric
types</a> and static arrays to enable even greater performance than that
of core Python. However if these restrictions are ignored, the
performance can become significantly worse.</p>
<!--
TODO: It might be nice to use the figure from https://jakevdp.github.io/blog/2014/05/09/why-python-is-slow/#3.-Python's-object-model-can-lead-to-inefficient-memory-access here for illustration?

![Illustration of a NumPy array and a Python list.](episodes/fig/numpyarray_vs_pylist.png){alt="A diagram illustrating the difference between a NumPy array and a Python list. The NumPy array is a raw block of memory containing numerical values. A Python list contains a header with metadata and multiple items, each of which is a reference to another Python object with its own header and value."}
-->
<div class="section level3">
<h3 id="numpy-arrays-and-python-lists-live-in-two-separate-worlds">NumPy Arrays and Python Lists Live in Two Separate Worlds<a class="anchor" aria-label="anchor" href="#numpy-arrays-and-python-lists-live-in-two-separate-worlds"></a></h3>
<p>NumPy’s arrays (not to be confused with the core Python
<code>array</code> package) are static arrays. Unlike core Python’s
lists, they do not dynamically resize. Therefore if you wish to append
to a NumPy array, you must call <code>resize()</code> first. If you
treat this like <code>append()</code> for a Python list, resizing for
each individual append, you will be performing significantly more copies
and memory allocations than a Python list.</p>
<p>The below example sees lists and arrays constructed from
<code>range(100000)</code>.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">100000</span>  <span class="co"># Number of elements in list/array</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="kw">def</span> list_append():</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>    ls <span class="op">=</span> []</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>        ls.append(i)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="kw">def</span> array_resize():</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>    ar <span class="op">=</span> numpy.zeros(<span class="dv">1</span>)</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, N):</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>        ar.resize(i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>        ar[i] <span class="op">=</span> i</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>        </span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"list_append: </span><span class="sc">{</span>timeit(list_append, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"array_resize: </span><span class="sc">{</span>timeit(array_resize, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>For Python lists, we’ve seen earlier that list comprehensions are
more efficient, so we prefer to avoid using a large number of
<code>append</code> operations if possible. Similarly, we should try to
avoid resizing NumPy arrays, where the overhead is even higher (5.2x
slower than a list, probably 10x slower than list comprehension).</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>list_append: 3.50ms
array_resize: 18.04ms</code></pre>
</div>
<p>Another difference, is that NumPy arrays typically require all data
to be the same type (and a NumPy type). This enables more efficient
access to elements, as they all exist contiguously in memory. In
contrast, elements within Python lists can be of any type so the list
always stores a pointer to where the element actually exists in memory,
rather than the actual element. This has the side effect that if you are
converting back and forth between Python lists and NumPy arrays, there
is an additional overhead as it’s not as simple as copying a single
block of memory.</p>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>If you construct a NumPy array from a list containing a complex
object, it will store your data as Python types and you won’t be able to
take advantage of NumPy’s optimisations.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="op">&gt;</span>python</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> import <span class="ex">numpy</span> as np</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> a <span class="ex">=</span> np.array<span class="er">(</span><span class="ex">[0.5,</span> 5]<span class="kw">)</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">a</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'numpy.float64'</span><span class="op">&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">a</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'numpy.float64'</span><span class="op">&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> b <span class="ex">=</span> np.array<span class="er">(</span><span class="ex">[0.5,</span> 5,{<span class="st">"foo"</span>:5}]<span class="kw">)</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">b</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'float'</span><span class="op">&gt;</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">b</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'int'</span><span class="op">&gt;</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> type<span class="kw">(</span><span class="va">b</span><span class="op">[</span><span class="dv">2</span><span class="op">]</span><span class="kw">)</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="op">&lt;</span>class <span class="st">'dict'</span><span class="op">&gt;</span></span></code></pre>
</div>
</div>
</div>
</div>
<p>The below example demonstrates the overhead of mixing Python lists
and NumPy functions.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Python list, numpy.random.choice()</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="op">&gt;</span>python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ls = list(range(10000))"</span> <span class="st">"numpy.random.choice(ls)"</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="ex">1000</span> loops, best of 5: 267 usec per loop</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co"># NumPy array, numpy.random.choice()</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="op">&gt;</span>python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ar = numpy.arange(10000)"</span> <span class="st">"numpy.random.choice(ar)"</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="ex">50000</span> loops, best of 5: 4.06 usec per loop</span></code></pre>
</div>
<p>Passing a Python list to <code>numpy.random.choice()</code> is 65.6x
slower than passing a NumPy array. This is the additional overhead of
converting the list to an array. If this function were called multiple
times, it would make sense to transform the list to an array before
calling the function so that overhead is only paid once.</p>
<div id="callout2" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Python list, Manually select 1 item</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="op">&gt;</span>python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ls = list(range(10000))"</span> <span class="st">"ls[numpy.random.randint(len(ls))]"</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="ex">200000</span> loops, best of 5: 1.19 usec per loop</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co"># NumPy array, Manually select 1 item</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="op">&gt;</span>python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ar = numpy.arange(10000)"</span> <span class="st">"ar[numpy.random.randint(len(ar))]"</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="ex">200000</span> loops, best of 5: 1.22 usec per loop</span></code></pre>
</div>
<p>Regardless, for this simple application of
<code>numpy.random.choice()</code>, merely using
<code>numpy.random.randint(len())</code> is around 4x faster regardless
whether a Python list or NumPy array is used.</p>
<p>With <code>numpy.random.choice()</code> being such a general function
(it has many possible parameters), there is significant internal
branching. If you don’t require this advanced functionality and are
calling a function regularly, it can be worthwhile considering using a
more limited function.</p>
<p>There is however a trade-off, using
<code>numpy.random.choice()</code> can be clearer to someone reading
your code, and is more difficult to use incorrectly.</p>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="array-broadcasting">Array Broadcasting<a class="anchor" aria-label="anchor" href="#array-broadcasting"></a></h3>
<p>NumPy arrays support “<a href="https://numpy.org/doc/stable/user/basics.broadcasting.html" class="external-link">broadcasting</a>”
many mathematical operations or functions. This is a shorthand notation,
where the operation/function is applied element-wise without having to
loop over the array explicitly:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ar <span class="op">=</span> np.arange(<span class="dv">6</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ar</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>array([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>])</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ar <span class="op">+</span> <span class="dv">10</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>array([<span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>, <span class="dv">14</span>, <span class="dv">15</span>])</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ar <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>array([ <span class="dv">0</span>,  <span class="dv">2</span>,  <span class="dv">4</span>,  <span class="dv">6</span>,  <span class="dv">8</span>, <span class="dv">10</span>])</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ar<span class="op">**</span><span class="dv">2</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>array([ <span class="dv">0</span>,  <span class="dv">1</span>,  <span class="dv">4</span>,  <span class="dv">9</span>, <span class="dv">16</span>, <span class="dv">25</span>])</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> np.exp(ar)</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>array([  <span class="fl">1.</span>        ,   <span class="fl">2.71828183</span>,   <span class="fl">7.3890561</span> ,  <span class="fl">20.08553692</span>,</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>        <span class="fl">54.59815003</span>, <span class="fl">148.4131591</span> ])</span></code></pre>
</div>
<div id="callout3" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>If you try the same with Python lists, it will usually fail with an
error or give an unexpected result:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ls <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">6</span>))</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ls <span class="op">+</span> <span class="dv">10</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>Traceback (most recent call last):</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  File <span class="st">"&lt;python-input-8&gt;"</span>, line <span class="dv">1</span>, <span class="kw">in</span> <span class="op">&lt;</span>module<span class="op">&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>    ls <span class="op">+</span> <span class="dv">10</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    <span class="op">~~~^~~~</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="pp">TypeError</span>: can only concatenate <span class="bu">list</span> (<span class="kw">not</span> <span class="st">"int"</span>) to <span class="bu">list</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ls <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> ls <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>Traceback (most recent call last):</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  File <span class="st">"&lt;python-input-10&gt;"</span>, line <span class="dv">1</span>, <span class="kw">in</span> <span class="op">&lt;</span>module<span class="op">&gt;</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>    ls <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>    <span class="op">~~~^^~~</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="pp">TypeError</span>: unsupported operand <span class="bu">type</span>(s) <span class="cf">for</span> <span class="op">**</span> <span class="kw">or</span> <span class="bu">pow</span>(): <span class="st">'list'</span> <span class="kw">and</span> <span class="st">'int'</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> np.exp(ls)  <span class="co"># works but is slower, because NumPy converts the list into an array first</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>array([  <span class="fl">1.</span>        ,   <span class="fl">2.71828183</span>,   <span class="fl">7.3890561</span> ,  <span class="fl">20.08553692</span>,</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>        <span class="fl">54.59815003</span>, <span class="fl">148.4131591</span> ])</span></code></pre>
</div>
</div>
</div>
</div>
<p>However, broadcasting is not just a nicer way to write mathematical
expressions—it can also give a significant performance boost: Most
modern processors are able to apply one instruction across multiple
variables simultaneously, instead of sequentially. (In computer science,
this is also referred to as “vectorisation”.) The manner by which NumPy
stores data in arrays enables it to vectorise mathematical operations
that are broadcast across arrays.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="op">&gt;</span> python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ar = numpy.arange(1)"</span> <span class="st">"ar + 10"</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="ex">1000000</span> loops, best of 5: 359 nsec per loop</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="op">&gt;</span> python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ar = numpy.arange(10)"</span> <span class="st">"ar + 10"</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="ex">1000000</span> loops, best of 5: 362 nsec per loop</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="op">&gt;</span> python <span class="ex">-m</span> timeit <span class="at">-s</span> <span class="st">"import numpy; ar = numpy.arange(100)"</span> <span class="st">"ar + 10"</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="ex">1000000</span> loops, best of 5: 364 nsec per loop</span></code></pre>
</div>
<p>If we were to use a regular <code>for</code> loop, the time to
perform this operation would increase with the length of the array.
However, using NumPy broadcasting we can apply the addition to 1, 10 or
100 elements, all in the same amount of time!</p>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div> Instructor Note </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p>A simple analogy:</p>
<p>If you’re baking cookies, the oven (CPU register) is big enough to
operate on multiple cookies (numbers) simultaneously. So whether you
bake 1 cookie or 10, it’ll take exactly the same amount of time.
However, this requires that the cookies are neatly arranged on a baking
tray (in a contiguous chunk of memory).</p>
<p>Basic ints/floats in NumPy arrays are arranged like that, so this
works great. In contrast, numbers in a Python list <a href="https://jakevdp.github.io/blog/2014/05/09/why-python-is-slow/#3.-Python's-object-model-can-lead-to-inefficient-memory-access" class="external-link">are
spread across memory in a fairly complex arrangement</a>, so cannot
benefit from this unless you convert them to a NumPy array first.</p>
</div>
</div>
</div>
</div>
<p>Earlier it was demonstrated that using core Python methods over a
list will outperform a loop, performing the same calculation faster. The
below example takes this a step further by demonstrating the calculation
of a dot product.</p>
<!-- Inspired by High Performance Python Chapter 6 example
Added Python sum array, skipped a couple of others-->
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">1000000</span>  <span class="co"># Number of elements in list</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>gen_list <span class="op">=</span> <span class="ss">f"ls = list(range(</span><span class="sc">{</span>N<span class="sc">}</span><span class="ss">))"</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>gen_array <span class="op">=</span> <span class="ss">f"import numpy; ar = numpy.arange(</span><span class="sc">{</span>N<span class="sc">}</span><span class="ss">, dtype=numpy.int64)"</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>py_sum_ls <span class="op">=</span> <span class="st">"sum([i*i for i in ls])"</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>py_sum_ar <span class="op">=</span> <span class="st">"sum(ar*ar)"</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>np_sum_ar <span class="op">=</span> <span class="st">"numpy.sum(ar*ar)"</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>np_dot_ar <span class="op">=</span> <span class="st">"numpy.dot(ar, ar)"</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"python_sum_list: </span><span class="sc">{</span>timeit(py_sum_ls, setup<span class="op">=</span>gen_list, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"python_sum_array: </span><span class="sc">{</span>timeit(py_sum_ar, setup<span class="op">=</span>gen_array, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"numpy_sum_array: </span><span class="sc">{</span>timeit(np_sum_ar, setup<span class="op">=</span>gen_array, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"numpy_dot_array: </span><span class="sc">{</span>timeit(np_dot_ar, setup<span class="op">=</span>gen_array, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<ul><li>
<code>python_sum_list</code> uses list comprehension to perform the
multiplication, followed by the Python core <code>sum()</code>. This
comes out at 46.93ms</li>
<li>
<code>python_sum_array</code> instead directly multiplies the two
arrays (taking advantage of NumPy’s vectorisation) but uses the core
Python <code>sum()</code>, this comes in slightly faster at
33.26ms.</li>
<li>
<code>numpy_sum_array</code> again takes advantage of NumPy’s
vectorisation for the multiplication, and additionally uses NumPy’s
<code>sum()</code> implementation. These two rounds of vectorisation
provide a much faster 1.44ms completion.</li>
<li>
<code>numpy_dot_array</code> instead uses NumPy’s <code>dot()</code>
to calculate the dot product in a single operation. This comes out the
fastest at 0.29ms, 162x faster than <code>python_sum_list</code>.</li>
</ul><div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>python_sum_list: 46.93ms
python_sum_array: 33.26ms
numpy_sum_array: 1.44ms
numpy_dot_array: 0.29ms</code></pre>
</div>
<div id="parallel-numpy" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="parallel-numpy" class="callout-inner">
<h3 class="callout-title">Parallel NumPy</h3>
<div class="callout-content">
<!-- https://superfastpython.com/multithreaded-numpy-functions/ -->
<p>NumPy can sometimes take advantage of auto parallelisation,
particularly on HPC systems.</p>
<p>A small number of functions are backed by BLAS and LAPACK, enabling
even greater speedup.</p>
<p>The <a href="https://numpy.org/doc/stable/reference/routines.linalg.html" class="external-link">supported
functions</a> mostly correspond to linear algebra operations like
<code>numpy.dot()</code>.</p>
<p>The auto-parallelisation of these functions is hardware dependant, so
you won’t always automatically get the additional benefit of
parallelisation. However, HPC systems should be primed to take
advantage, so try increasing the number of cores you request when
submitting your jobs and see if it improves the performance.</p>
<p><em>This might be why <code>numpy_dot_array</code> is that much
faster than <code>numpy_sum_array</code> in the previous
example!</em></p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="other-libraries-that-use-numpy">Other Libraries That Use NumPy<a class="anchor" aria-label="anchor" href="#other-libraries-that-use-numpy"></a></h2>
<hr class="half-width"><p>Across the scientific Python software ecosystem, <a href="https://numpy.org/#:~:text=ECOSYSTEM" class="external-link">many domain-specific
packages</a> are built on top of NumPy arrays. Similar to the demos
above, we can often gain significant performance boosts by using these
libraries well.</p>
<div id="challenge-which-libraries-are-you-using-already" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-which-libraries-are-you-using-already" class="callout-inner">
<h3 class="callout-title">Challenge: Which Libraries Are You Using Already?</h3>
<div class="callout-content">
<p>Take a look at the <a href="https://numpy.org/#:~:text=ECOSYSTEM" class="external-link">list of libraries on the
NumPy website</a>. Are you using any of them already?</p>
<p>If you’ve brought a project you want to work on: Are there areas of
the project where you might benefit from adapting one of these libraries
instead of writing your own code from scratch?</p>
</div>
</div>
</div>
<div id="accordionHint1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button hint-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHint1" aria-expanded="false" aria-controls="collapseHint1">
  <h4 class="accordion-header" id="headingHint1"> Give me a hint </h4>
</button>
<div id="collapseHint1" class="accordion-collapse collapse" data-bs-parent="#accordionHint1" aria-labelledby="headingHint1">
<div class="accordion-body">
<p>These libraries could be specific to your area of research; but they
could also include packages from other fields that provide tools you
need (e.g. statistics or machine learning)!</p>
</div>
</div>
</div>
</div>
<p>Which libraries you may use will depend on your research domain;
here, we’ll show an example from bioinformatics.</p>
<div class="section level3">
<h3 id="example-image-analysis-with-shapely">Example: Image Analysis with Shapely<a class="anchor" aria-label="anchor" href="#example-image-analysis-with-shapely"></a></h3>
<p>A bioinformatics researcher had a large data set of images of cells.
She had already reconstructed the locations of cell walls and various
points of interest and needed to identify which points were located in
each cell. To do this, she used the <a href="https://github.com/shapely/shapely" class="external-link">Shapely</a> geometry
library.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>points_per_polygon <span class="op">=</span> {}</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="cf">for</span> polygon_idx <span class="kw">in</span> <span class="bu">range</span>(n_polygons):</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    current_polygon <span class="op">=</span> polygons.iloc[polygon_idx,:][<span class="st">"geometry"</span>]</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="co"># manually loop over all points, check if polygon contains that point</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    out_points <span class="op">=</span> []</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_points):</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>        current_point <span class="op">=</span> points.iloc[i, :]</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>        <span class="cf">if</span> current_polygon.contains(current_point[<span class="st">"geometry"</span>]):</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>            out_points.append(current_point.name)</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    points_per_polygon[polygon_idx] <span class="op">=</span> out_points</span></code></pre>
</div>
<p>For about 500k points and 1000 polygons, the initial version of the
code took about 20 hours to run.</p>
<p>Luckily, Shapely is built on top of NumPy, so she was able to apply
functions to an array of points instead and wrote an improved version,
which took just 20 minutes:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># 1) Extract points and corresponding names as two separate NumPy arrays from a larger data frame</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co"># This will make it easier to apply vectorised functions below</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>points_array <span class="op">=</span> np.array(points.loc[:,<span class="st">"geometry"</span>])</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>point_names_array <span class="op">=</span> np.array(points.loc[:,<span class="st">"name"</span>])</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>points_per_polygon <span class="op">=</span> {}</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="cf">for</span> polygon_idx <span class="kw">in</span> <span class="bu">range</span>(n_polygons):</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>    current_polygon <span class="op">=</span> polygons.iloc[polygon_idx,:][<span class="st">"geometry"</span>]</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>    <span class="co"># 2) apply `contains` to an array of points, rather than an individual point</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>    points_in_polygon_idx <span class="op">=</span> current_polygon.contains(points_array)</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>    <span class="co"># 3) Filter `point_names_array` to get just the names of points contained in the polygon</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>    points_in_polygon <span class="op">=</span> point_names_array[points_in_polygon_idx]</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>    <span class="co"># 4) Turn this array into a Python list and store it in output data</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>    points_per_polygon[polygon_idx] <span class="op">=</span> points_in_polygon.tolist()</span></code></pre>
</div>
<p>To vectorise this efficiently, the logic of the code had to be
changed slightly:</p>
<ol style="list-style-type: decimal"><li>The improved code starts by extracting the
<code>shapely.Point</code>s and corresponding point names as two
separate NumPy arrays from a larger data frame.</li>
<li>It then passes that array of points to
<code>current_polygon.contains()</code>, which uses vectorisation to
speed up the calculation. It returns a NumPy array of booleans
(<code>True</code> or <code>False</code>), describing for each
<code>Point</code> in the input array whether it is contained in
<code>current_polygon</code>.</li>
<li>This boolean array is then <a href="https://numpy.org/doc/stable/user/basics.indexing.html#boolean-array-indexing" class="external-link">passed
as an index</a> to the <code>point_names_list</code> array. This returns
a new array with the names of all points that are contained in the
polygon (i.e. where the boolean array had the value
<code>True</code>).</li>
<li>Finally, the contained points are stored as a Python list. (In this
particular case, later parts of the data analysis code expected a list
instead of a NumPy array. Since those parts of the code were “fast
enough”—remember Donald Knuth’s quote in the earlier episode?—the
researcher decided not to spend more time to rewrite them.)</li>
</ol><div id="accordionInstructor2" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor2" aria-expanded="false" aria-controls="collapseInstructor2">
  <h3 class="accordion-header" id="headingInstructor2">  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div> Instructor Note </h3>
</button>
<div id="collapseInstructor2" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor2" aria-labelledby="headingInstructor2">
<div class="accordion-body">
<p>The following code snippet demonstrates how this works for a
simplified example.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> shapely <span class="im">import</span> Point, Polygon</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> polygon <span class="op">=</span> Polygon([(<span class="dv">0</span>,<span class="dv">0</span>), (<span class="dv">1</span>,<span class="dv">0</span>), (<span class="dv">1</span>,<span class="dv">1</span>), (<span class="dv">0</span>,<span class="dv">1</span>), (<span class="dv">0</span>,<span class="dv">0</span>)])</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> points_array <span class="op">=</span> np.array((Point(<span class="fl">0.1</span>, <span class="fl">0.1</span>), Point(<span class="fl">0.5</span>, <span class="fl">0.5</span>), Point(<span class="dv">2</span>, <span class="dv">2</span>)))</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> point_names_array <span class="op">=</span> np.array((<span class="st">"P1: Periphery"</span>, <span class="st">"P2: Centre"</span>, <span class="st">"P3: Outside"</span>))</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> points_in_polygon_idx <span class="op">=</span> polygon.contains(points_array)</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> points_in_polygon_idx</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>array([ <span class="va">True</span>,  <span class="va">True</span>, <span class="va">False</span>])</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> points_in_polygon <span class="op">=</span> point_names_array[points_in_polygon_idx]</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> points_in_polygon</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>array([<span class="st">'P1: Periphery'</span>, <span class="st">'P2: Centre'</span>], dtype<span class="op">=</span><span class="st">'&lt;U13'</span>)</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> points_in_polygon.tolist()</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>[<span class="st">'P1: Periphery'</span>, <span class="st">'P2: Centre'</span>]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<!--
TODO: The following example needs more work to be used by instructors other than me.
And since it’s not a very clean example (mixes np arrays and list comprehensions) and hard to extract a nice before/after snippet, maybe it’s better not to include this example in the general course materials? Or only in a callout or instructor note?
-->
<!--
### Example: Interpolating astrophysical spectra with AstroPy

This is from an open-source package I'm working on, so we can look at the actual pull request where I made this change: https://github.com/SNEWS2/snewpy/pull/310

&rightarrow; See the first table of benchmark results. Note that using a Python `for` loop to calculate the spectrum in 100 different time bins takes 100 times as long as for a single time bin. In the vectorized version, the computing time increases much more slowly.

(Note that energies were already vectorized—that's another factor of 100 we got "for free"!)

Code diff: https://github.com/SNEWS2/snewpy/pull/310/commits/0320b384ff22233818d07913c55c30f5968ae330
 -->
</div>
</section><section><h2 class="section-heading" id="using-pandas-effectively">Using Pandas (Effectively)<a class="anchor" aria-label="anchor" href="#using-pandas-effectively"></a></h2>
<hr class="half-width"><p><a href="https://pandas.pydata.org/" class="external-link">Pandas</a> is the most common
Python package used for scientific computing when working with tabular
data akin to spreadsheets (DataFrames).</p>
<p>Similar to NumPy, Pandas enables greater performance than pure Python
implementations when used correctly, however incorrect usage can
actively harm performance.</p>
<div class="section level3">
<h3 id="operating-on-rows">Operating on Rows<a class="anchor" aria-label="anchor" href="#operating-on-rows"></a></h3>
<p>Pandas’ methods by default operate on columns. Each column or series
can be thought of as a NumPy array, highly suitable for
vectorisation.</p>
<p>Following the theme of this episode, iterating over the rows of a
data frame using a <code>for</code> loop is not advised. The pythonic
iteration will be slower than other approaches.</p>
<p>Pandas allows its own methods to be applied to rows in many cases by
passing <code>axis=1</code>, where available these functions should be
preferred over manual loops. Where you can’t find a suitable method,
<code>apply()</code> can be used, which is similar to
<code>map()</code>, to apply your own function to rows.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="im">import</span> pandas</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="im">import</span> numpy</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">100000</span>  <span class="co"># Number of rows in DataFrame</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="kw">def</span> genDataFrame():</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>    numpy.random.seed(<span class="dv">12</span>)  <span class="co"># Ensure each dataframe is identical</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>    <span class="cf">return</span> pandas.DataFrame(</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>    {</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>        <span class="st">"f_vertical"</span>: numpy.random.random(size<span class="op">=</span>N),</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>        <span class="st">"f_horizontal"</span>: numpy.random.random(size<span class="op">=</span>N),</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>        <span class="co"># todo some spurious columns</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>    })</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a><span class="kw">def</span> pythagoras(row):</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>    <span class="cf">return</span> (row[<span class="st">"f_vertical"</span>]<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> row[<span class="st">"f_horizontal"</span>]<span class="op">**</span><span class="dv">2</span>)<span class="op">**</span><span class="fl">0.5</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>    </span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a><span class="kw">def</span> for_range():</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>    rtn <span class="op">=</span> []</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>    <span class="cf">for</span> row_idx <span class="kw">in</span> <span class="bu">range</span>(df.shape[<span class="dv">0</span>]):</span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>        row <span class="op">=</span> df.iloc[row_idx]</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>        rtn.append(pythagoras(row))</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>    <span class="cf">return</span> pandas.Series(rtn)</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a><span class="kw">def</span> for_iterrows():</span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a>    rtn <span class="op">=</span> []</span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a>    <span class="cf">for</span> row_idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a>        rtn.append(pythagoras(row))</span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a>    <span class="cf">return</span> pandas.Series(rtn)</span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a>    </span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a><span class="kw">def</span> pandas_apply():</span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a>    <span class="cf">return</span> df.<span class="bu">apply</span>(pythagoras, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a>gentime <span class="op">=</span> timeit(genDataFrame, number<span class="op">=</span>repeats)</span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"for_range: </span><span class="sc">{</span>timeit(for_range, number<span class="op">=</span>repeats)<span class="op">*</span><span class="dv">10</span><span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"for_iterrows: </span><span class="sc">{</span>timeit(for_iterrows, number<span class="op">=</span>repeats)<span class="op">*</span><span class="dv">10</span><span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb14-42"><a href="#cb14-42" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"pandas_apply: </span><span class="sc">{</span>timeit(pandas_apply, number<span class="op">=</span>repeats)<span class="op">*</span><span class="dv">10</span><span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p><code>apply()</code> is 4x faster than the two <code>for</code>
approaches, as it avoids the Python <code>for</code> loop.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>for_range: 1582.47ms
for_iterrows: 1677.14ms
pandas_apply: 390.49ms</code></pre>
</div>
<p>However, rows don’t exist in memory as arrays (columns do!), so
<code>apply()</code> does not take advantage of NumPy’s vectorisation.
You may be able to go a step further and avoid explicitly operating on
rows entirely by passing only the required columns to NumPy.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="kw">def</span> vectorize():</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    <span class="cf">return</span> pandas.Series(numpy.sqrt(numpy.square(df[<span class="st">"f_vertical"</span>]) <span class="op">+</span> numpy.square(df[<span class="st">"f_horizontal"</span>])))</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    </span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"vectorize: </span><span class="sc">{</span>timeit(vectorize, number<span class="op">=</span>repeats)<span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>264x faster than <code>apply()</code>, 1000x faster than the two
<code>for</code> approaches!</p>
<pre><code>vectorize: 1.48ms</code></pre>
<p>It won’t always be possible to take full advantage of vectorisation,
for example you may have conditional logic.</p>
<p>An alternate approach is converting your dataframe to a Python
dictionary using <code>to_dict(orient='index')</code>. This creates a
nested dictionary, where each row of the outer dictionary is an internal
dictionary. This can then be processed via list-comprehension:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="kw">def</span> to_dict():</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    df <span class="op">=</span> genDataFrame()</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    df_as_dict <span class="op">=</span> df.to_dict(orient<span class="op">=</span><span class="st">'index'</span>)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    <span class="cf">return</span> pandas.Series([(r[<span class="st">'f_vertical'</span>]<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> r[<span class="st">'f_horizontal'</span>]<span class="op">**</span><span class="dv">2</span>)<span class="op">**</span><span class="fl">0.5</span> <span class="cf">for</span> r <span class="kw">in</span> df_as_dict.values()])</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"to_dict: </span><span class="sc">{</span>timeit(to_dict, number<span class="op">=</span>repeats)<span class="op">*</span><span class="dv">10</span><span class="op">-</span>gentime<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>Whilst still nearly 100x slower than pure vectorisation, it’s twice
as fast as <code>apply()</code>.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="ex">to_dict:</span> 131.15ms</span></code></pre>
</div>
<p>This is because indexing into Pandas’ <code>Series</code> (rows) is
significantly slower than a Python dictionary. There is a slight
overhead to creating the dictionary (40ms in this example), however the
stark difference in access speed is more than enough to overcome that
cost for any large dataframe.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> timeit</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pandas</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">100000</span>  <span class="co"># Number of rows in DataFrame</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="kw">def</span> genInput():</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>    s <span class="op">=</span> pandas.Series({<span class="st">'a'</span> : <span class="dv">1</span>, <span class="st">'b'</span> : <span class="dv">2</span>})</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>    d <span class="op">=</span> {<span class="st">'a'</span> : <span class="dv">1</span>, <span class="st">'b'</span> : <span class="dv">2</span>}</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>    <span class="cf">return</span> s, d</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="kw">def</span> series():</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>    s, _ <span class="op">=</span> genInput()</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>        y <span class="op">=</span> s[<span class="st">'a'</span>] <span class="op">*</span> s[<span class="st">'b'</span>]</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a><span class="kw">def</span> dictionary():</span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>    _, d <span class="op">=</span> genInput()</span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a>        y <span class="op">=</span> d[<span class="st">'a'</span>] <span class="op">*</span> d[<span class="st">'b'</span>]</span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a>repeats <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"series: </span><span class="sc">{</span>timeit(series, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"dictionary: </span><span class="sc">{</span>timeit(dictionary, number<span class="op">=</span>repeats)<span class="sc">:.2f}</span><span class="ss">ms"</span>)</span></code></pre>
</div>
<p>65x slower!</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>series: 237.25ms
dictionary: 3.63ms</code></pre>
</div>
</div>
<div class="section level3">
<h3 id="filter-early">Filter Early<a class="anchor" aria-label="anchor" href="#filter-early"></a></h3>
<p>If you can filter your rows before processing, rather than after, you
may significantly reduce the amount of processing and memory used.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul><li>Python is an interpreted language, this adds an additional overhead
at runtime to the execution of Python code. Many core Python and NumPy
functions are implemented in faster C/C++, free from this overhead.</li>
<li>NumPy can take advantage of vectorisation to process arrays, which
can greatly improve performance.</li>
<li>Many domain-specific packages are built on top of NumPy and can
offer similar performance boosts.</li>
<li>Pandas’ data tables store columns as arrays, therefore operations
applied to columns can take advantage of NumPy’s vectorisation.</li>
</ul></div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/long-break1.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/optimisation-use-latest.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/long-break1.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Break
        </a>
        <a class="chapter-link float-end" href="../instructor/optimisation-use-latest.html" rel="next">
          Next: Keep Python &amp;...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-2">
        <a href="https://docs.hpc.shef.ac.uk/en/latest/stanage/index.html" class="external-link">
          <img alt="Stanage HPC" src="https://docs.hpc.shef.ac.uk/en/latest/_images/Stanage_Black.png" style="width: 100%;" class="dark-invert"></a>
        <p><a href="https://sites.google.com/sheffield.ac.uk/research-training/research-training" class="external-link">Research Computing Training Home</a></p>
			</div>
			<div class="col-md-5">
        <p>Lesson developed by <a href="https://rse.shef.ac.uk" class="external-link">RSE</a> &amp; <a href="https://www.sheffield.ac.uk/it-services/research" class="external-link">RIT</a></p>
        <p>

          <a href="https://github.com/RSE-Sheffield/pando-python/edit/main/episodes/optimisation-numpy.md" class="external-link">Edit on GitHub</a>


        | <a href="https://github.com/RSE-Sheffield/pando-python/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/RSE-Sheffield/pando-python/" class="external-link">Source</a>
        </p>
		<p>
          <a href="https://github.com/RSE-Sheffield/pando-python/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:robert.chisholm@sheffield.ac.uk">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a> | <a href="CODE_OF_CONDUCT.html">Code of Conduct</a>
        </p>
		</div>
		<div class="col-md-5">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>


        <!--<p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY 4.0</a> by <a href="https://carpentries.org/">The Carpentries</a></p>-->
        <!--<p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11">sandpaper (0.16.11)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9">pegboard (0.7.9)</a>, and <a href="https://github.com/RSE-Sheffield/uos-varnish/tree/main">varnish (1.0.4)</a></p>-->
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11" class="external-link">sandpaper (0.16.11)</a>,
        <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>,
      and <a href="https://github.com/RSE-Sheffield/uos-varnish/tree/main" class="external-link">varnish (1.0.4) [UoS fork]</a>.</p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://rse.shef.ac.uk/pando-python/instructor/optimisation-numpy.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "python, profiling, optimisation, data structures, algorithms",
  "name": "Using Scientific Python Packages (NumPy, Pandas and more)",
  "creativeWorkStatus": "active",
  "url": "https://rse.shef.ac.uk/pando-python/instructor/optimisation-numpy.html",
  "identifier": "https://rse.shef.ac.uk/pando-python/instructor/optimisation-numpy.html",
  "dateCreated": "2024-02-01",
  "dateModified": "2025-03-12",
  "datePublished": "2025-03-12"
}

  </script><script>
		feather.replace();
	</script><script defer src="https://cloud.umami.is/script.js" data-website-id="95b3ca57-3bd9-47b0-b1ca-fe819ef65c80"></script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

