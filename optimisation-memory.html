<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Performance Profiling &amp; Optimisation (Python): Understanding Memory</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="icon" href="assets/images/UOSSheild_Primary_Violet_RGB.ico" sizes="any"><link rel="icon" href="assets/images/UOSSheild_Primary_Violet_RGB.svg" type="image/svg+xml"><link rel="manifest" href="site.webmanifest"><link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"></head><body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">      
        <a href="https://www.sheffield.ac.uk" class="external-link">
          <img alt="University of Sheffield" src="assets/images/UOSLogo_Primary_Violet_RGB.svg"></a>
        
        <abbr class="badge badge-light" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="background-color: #FF4955; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #000">
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
            Pre-Alpha
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/optimisation-memory.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="University of Sheffield" src="assets/images/UOSSheild_Primary_Violet_RGB.svg"></div>
    <div class="lesson-title-md">
      Performance Profiling &amp; Optimisation (Python)
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Performance Profiling &amp; Optimisation (Python)
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="acknowledgements.html">Acknowledgements</a></li>
          </ul></li>
      </ul></div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled><input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset></form>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Performance Profiling &amp; Optimisation (Python)
</div>

<aside class="col-md-12 lesson-progress"><div style="width: NaN%" class="percentage">
    NaN%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: NaN%" aria-valuenow="NaN" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/optimisation-memory.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->
      
            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="profiling-introduction.html">1. Introduction to Profiling</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="profiling-functions.html">2. Function Level Profiling</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="profiling-lines.html">3. Line Level Profiling</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="profiling-conclusion.html">4. Profiling Conclusion</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="optimisation-introduction.html">5. Introduction to Optimisation</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="optimisation-data-structures-algorithms.html">6. Data Structures &amp; Algorithms</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="optimisation-minimise-python.html">7. Minimise Python (NumPY/Pandas)</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="optimisation-use-latest.html">8. Keep Python &amp; Packages up to Date</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        9. Understanding Memory
        </span>
      </button>
    </div><!--/div.accordion-header-->
        
    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#accessing-variables">Accessing Variables</a></li>
<li><a href="#accessing-disk">Accessing Disk</a></li>
<li><a href="#latency-overview">Latency Overview</a></li>
<li><a href="#memory-allocation-is-not-free">Memory Allocation is not Free</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="optimisation-conclusion.html">10. Optimisation Conclusion</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="acknowledgements.html">Acknowledgements</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">
            
            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="optimisation-use-latest.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="optimisation-conclusion.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="optimisation-use-latest.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Keep Python &amp;
        </a>
        <a class="chapter-link float-end" href="optimisation-conclusion.html" rel="next">
          Next: Optimisation... 
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Understanding Memory</h1>
        <p>Last updated on 2024-02-08 |
        
        <a href="https://github.com/RSE-Sheffield/pando-python/edit/main/episodes/optimisation-memory.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
        
        
        
        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How does a CPU look for a variable it requires?</li>
<li>What impact do cache lines have on memory accesses?</li>
<li>Why is it faster to read/write a single 100mb file, than 100 1mb
files?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Able to explain, at a high-level, how memory accesses occur during
computation and how this impacts optimisation considerations.</li>
<li>Able to identify the relationship between different latencies
relevant to software.</li>
</ul></div>
</div>
</div>
</div>
</div>
<section id="accessing-variables"><h2 class="section-heading">Accessing Variables<a class="anchor" aria-label="anchor" href="#accessing-variables"></a>
</h2>
<hr class="half-width"><p>The storage and movement of data plays a large role in the
performance of executing software.</p>
<!-- Brief summary of hardware -->
<p>Modern computer’s typically have a single processor (CPU), within
this processor there are multiple processing cores each capable of
executing different code in parallel.</p>
<p>Data held in memory by running software is exists in RAM, this memory
is faster to access than hard drives (and solid-state drives). But the
CPU has much smaller caches on-board, to make accessing the most recent
variables even faster.</p>
<p><img src="fig/annotated-motherboard.jpg" alt="An annotated photo of a computer’s hardware." class="figure">{alt=‘An annotated
photo of inside a desktop computer’s case. The CPU, RAM, power supply,
graphics cards (GPUs) and harddrive are labelled.’}</p>
<!-- Read/operate on variable ram->cpu cache->registers->cpu -->
<p>When reading a variable, to perform an operation with it, the CPU
will first look in it’s registers. These exist per core, they are the
location that computation is actually performed. Accessing them is
incredibly fast, but there only exists enough storage for around 32
variables (typical number, e.g. 4 bytes). As the register file is so
small, most variables won’t be found and the CPU’s caches will be
searched. It will first check the current processing core’s L1 (Level 1)
cache, this small cache (typically 64 KB per physical core) is the
smallest and fastest to access cache on a CPU. If the variable is not
found in the L1 cache, the L2 cache that is shared between multiple
cores will be checked. This shared cache, is slower to access but larger
than L1 (typically 1-3MB per core). This process then repeats for the L3
cache which may be shared among all cores of the CPU. This cache again
has higher latency to access, but increased size (typically slightly
larger than the total L2 cache size). If the variable has not been found
in any of the CPU’s cache, the CPU will look to the computer’s RAM. This
is an order of magnitude slower to access, with several orders of
magnitude greater capacity (tens to hundreds of GB are now
standard).</p>
<p>Correspondingly, the earlier the CPU finds the variable the faster it
will be to access. However, to fully understand the cache’s it’s
necessary to explain what happens once a variable has been found.</p>
<p>If a variable is not found in the caches, so must be fetched from
RAM. The full 64 byte cache line containing the variable, will be copied
first into the CPU’s L3, then L2 and then L1. Most variables are only 4
or 8 bytes, so many neighbouring variables are also pulled into the
caches. Similarly, adding new data to a cache evicts old data. This
means that reading 16 integers contiguously stored in memory, should be
faster than 16 scattered integers</p>
<p>Therefore, to <strong>optimally</strong> access variables they should
be stored contiguously in memory with related data and worked on whilst
they remain in caches. If you add to a variable, perform large amount of
unrelated processing, then add to the variable again it will likely have
been evicted from caches and need to be reloaded from slower RAM
again.</p>
<!-- Latency/Throughput typically inversely proportional to capacity -->
<p>It’s not necessary to remember this full detail of how memory access
work within a computer, but the context perhaps helps understand why
memory locality is important.</p>
<figure><img src="fig/hardware.png" alt="An abstract representation of a CPU, RAM and Disk, showing their internal caches and the pathways data can pass." class="figure mx-auto d-block"><figcaption>An abstract diagram showing the path data takes from
disk or RAM to be used for computation.</figcaption></figure><div id="callout1" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>Python as a programming language, does not give you enough control to
carefully pack your variables in this manner (every variable is an
object, so it’s stored as a pointer that redirects to the actual data
stored elsewhere).</p>
<p>However all is not lost, packages such as <code>numpy</code> and
<code>pandas</code> implemented in C/C++ enable Python users to take
advantage of efficient memory accesses (when they are used
correctly).</p>
</div>
</div>
</div>
<!-- TODO python code example 
```python

```-->
</section><section id="accessing-disk"><h2 class="section-heading">Accessing Disk<a class="anchor" aria-label="anchor" href="#accessing-disk"></a>
</h2>
<hr class="half-width"><!-- Read data from a file it goes disk->disk cache->ram->cpu cache/s->cpu --><p>When accessing data on disk (or network), a very similar process is
performed to that between CPU and RAM when accessing variables.</p>
<p>When reading data from a file, it transferred from the disk, to the
disk cache, to the RAM. The latency to access files on disk is another
order of magnitude higher than accessing RAM.</p>
<p>As such, disk accesses similarly benefit from sequential accesses and
reading larger blocks together rather than single variables. Python’s
<code>io</code> package is already buffered, so automatically handles
this for you in the background.</p>
<p>However before a file can be read, the file system on the disk must
be polled to transform the file path to it’s address on disk to initiate
the transfer (or throw an exception).</p>
<p>Following the common theme of this episode, the cost of accessing
randomly scattered files can be significantly slower than accessing a
single larger file of the same size. This is because for each file
accessed, the file system must be polled to transform the file path to
an address on disk. Traditional hard disk drives particularly suffer, as
the read head must physically move to locate data.</p>
<p>Hence, it can be wise to avoid storing outputs in many individual
files and to instead create a larger output file.</p>
<p>This is even visible outside of your own code. If you try to
upload/download 1 GB to HPC. The transfer will be significantly faster,
assuming good internet bandwidth, if that’s a single file rather than
thousands.</p>
<p>The below example code runs a small benchmark, whereby 10MB is
written to disk and read back whilst being timed. In one case this is as
a single file, and the other, 1000 file segments.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, time</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate 10MB</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>data_len <span class="op">=</span> <span class="dv">10000000</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> os.urandom(data_len)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>file_ct <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>file_len <span class="op">=</span> <span class="bu">int</span>(data_len<span class="op">/</span>file_ct)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Write one large file</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.perf_counter()</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>large_file <span class="op">=</span> <span class="bu">open</span>(<span class="st">"large.bin"</span>, <span class="st">"wb"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>large_file.write(data)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>large_file.close ()</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>large_write_s <span class="op">=</span> time.perf_counter() <span class="op">-</span> start</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Write multiple small files</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.perf_counter()</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(file_ct):</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    small_file <span class="op">=</span> <span class="bu">open</span>(<span class="ss">f"small_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">.bin"</span>, <span class="st">"wb"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    small_file.write(data[file_len<span class="op">*</span>i:file_len<span class="op">*</span>(i<span class="op">+</span><span class="dv">1</span>)])</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    small_file.close()</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>small_write_s <span class="op">=</span> time.perf_counter() <span class="op">-</span> start</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Read back the large file</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.perf_counter()</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>large_file <span class="op">=</span> <span class="bu">open</span>(<span class="st">"large.bin"</span>, <span class="st">"rb"</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> large_file.read(data_len)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>large_file.close ()</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>large_read_s <span class="op">=</span> time.perf_counter() <span class="op">-</span> start</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Read back the small files</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.perf_counter()</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(file_ct):</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    small_file <span class="op">=</span> <span class="bu">open</span>(<span class="ss">f"small_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">.bin"</span>, <span class="st">"rb"</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> small_file.read(file_len)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    small_file.close()</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>small_read_s <span class="op">=</span> time.perf_counter() <span class="op">-</span> start</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Print Summary</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="dv">1</span><span class="sc">:5d}</span><span class="ss">x</span><span class="sc">{</span>data_len<span class="op">/</span><span class="dv">1000000</span><span class="sc">}</span><span class="ss">MB Write: </span><span class="sc">{</span>large_write_s<span class="sc">:.5f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>file_ct<span class="sc">:5d}</span><span class="ss">x</span><span class="sc">{</span>file_len<span class="op">/</span><span class="dv">1000</span><span class="sc">}</span><span class="ss">KB Write: </span><span class="sc">{</span>small_write_s<span class="sc">:.5f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="dv">1</span><span class="sc">:5d}</span><span class="ss">x</span><span class="sc">{</span>data_len<span class="op">/</span><span class="dv">1000000</span><span class="sc">}</span><span class="ss">MB Read: </span><span class="sc">{</span>large_read_s<span class="sc">:.5f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>file_ct<span class="sc">:5d}</span><span class="ss">x</span><span class="sc">{</span>file_len<span class="op">/</span><span class="dv">1000</span><span class="sc">}</span><span class="ss">KB Read: </span><span class="sc">{</span>small_read_s<span class="sc">:.5f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>file_ct<span class="sc">:5d}</span><span class="ss">x</span><span class="sc">{</span>file_len<span class="op">/</span><span class="dv">1000</span><span class="sc">}</span><span class="ss">KB Write was </span><span class="sc">{</span>small_write_s<span class="op">/</span>large_write_s<span class="sc">:.1f}</span><span class="ss"> slower than 1x</span><span class="sc">{</span>data_len<span class="op">/</span><span class="dv">1000000</span><span class="sc">}</span><span class="ss">MB Write"</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>file_ct<span class="sc">:5d}</span><span class="ss">x</span><span class="sc">{</span>file_len<span class="op">/</span><span class="dv">1000</span><span class="sc">}</span><span class="ss">KB Read was </span><span class="sc">{</span>small_read_s<span class="op">/</span>large_read_s<span class="sc">:.1f}</span><span class="ss"> slower than 1x</span><span class="sc">{</span>data_len<span class="op">/</span><span class="dv">1000000</span><span class="sc">}</span><span class="ss">MB Read"</span>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleanup</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>os.remove(<span class="st">"large.bin"</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(file_ct):</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    os.remove(<span class="ss">f"small_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">.bin"</span>)</span></code></pre>
</div>
<p>Running this locally, with an SSD I received the following
timings.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">SH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode sh" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>    <span class="ex">1x10.0MB</span> Write: 0.00198 seconds</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">1000x10.0KB</span> Write: 0.14886 seconds</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">1x10.0MB</span> Read: 0.00478 seconds</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">1000x10.0KB</span> Read: 2.50339 seconds</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">1000x10.0KB</span> Write was 75.1 slower than 1x10.0MB Write</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">1000x10.0KB</span> Read was 523.9 slower than 1x10.0MB Read</span></code></pre>
</div>
<p>Repeated runs show some noise to the timing, however the slowdown is
consistently the same order of magnitude slower when split across
multiple files.</p>
<p>You might not even be reading 1000 different files. You could be
reading the same file multiple times, rather than reading it once and
retaining it in memory during execution. An even greater overhead would
apply.</p>
</section><section id="latency-overview"><h2 class="section-heading">Latency Overview<a class="anchor" aria-label="anchor" href="#latency-overview"></a>
</h2>
<hr class="half-width"><p>Latency can have a big impact on the speed that a program executes,
the below graph demonstrates this. Note the log scale!</p>
<figure><img src="fig/latency.png" alt="A horizontal bar chart displaying the relative latencies for L1/L2/L3 cache, RAM, SSD, HDD and a packet being sent from London to California and back. These latencies range from 1 nanosecond  to 140 milliseconds and are displayed with a log scale." class="figure mx-auto d-block"><figcaption>A graph demonstrating the wide variety of latencies a
programmer may experience when accessing data.</figcaption></figure><p>The lower the latency typically the higher the effective bandwidth.
L1 and L2 cache have 1TB/s, RAM 100GB/s, SSDs upto 32 GB/s, HDDs upto
150MB/s. Making large memory transactions even slower.</p>
</section><section id="memory-allocation-is-not-free"><h2 class="section-heading">Memory Allocation is not Free<a class="anchor" aria-label="anchor" href="#memory-allocation-is-not-free"></a>
</h2>
<hr class="half-width"><!-- Even "garbage collected" languages like Python have a cost. --><p>When a variable is created, memory must be located for it,
potentially requested from the operating system. This gives it an
overhead versus reusing existing allocations, or avoiding redundant
temporary allocations entirely.</p>
<p>Within Python memory is not explicitly allocated and deallocated,
instead it is automatically allocated and later “garbage collected”. The
costs are still there, this just means that Python programmers have less
control over where they occur.</p>
<!-- Based on the same premise as first example from Chapter 6 High Perf Python-->
<p>The below implementation of the <a href="https://en.wikipedia.org/wiki/Heat_equation" class="external-link">heat-equation</a>,
reallocates <code>out_grid</code>, a large 2 dimensional (500x500) list
each time <code>update()</code> is called which progresses the
model.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>grid_shape <span class="op">=</span> (<span class="dv">512</span>, <span class="dv">512</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update(grid, a_dt):</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    x_max, y_max <span class="op">=</span> grid_shape</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    out_grid <span class="op">=</span> [[<span class="fl">0.0</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(y_max)] <span class="op">*</span> y_max <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(x_max)]</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(x_max):</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(y_max):</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            out_xx <span class="op">=</span> grid[(i<span class="op">-</span><span class="dv">1</span>)<span class="op">%</span>x_max][j] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> grid[i][j] <span class="op">+</span> grid[(i<span class="op">+</span><span class="dv">1</span>)<span class="op">%</span>x_max][j]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            out_yy <span class="op">=</span> grid[i][(j<span class="op">-</span><span class="dv">1</span>)<span class="op">%</span>y_max] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> grid[i][j] <span class="op">+</span> grid[i][(j<span class="op">+</span><span class="dv">1</span>)<span class="op">%</span>y_max]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            out_grid[i][j] <span class="op">=</span> grid[i][j] <span class="op">+</span> (out_xx <span class="op">+</span> out_yy) <span class="op">*</span> a_dt </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out_grid</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> heat_equation(steps):</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    x_max, y_max <span class="op">=</span> grid_shape</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> [[<span class="fl">0.0</span>] <span class="op">*</span> y_max <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(x_max)]</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Init central point to diffuse</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    grid[<span class="bu">int</span>(x_max<span class="op">/</span><span class="dv">2</span>)][<span class="bu">int</span>(y_max<span class="op">/</span><span class="dv">2</span>)] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run steps</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(steps):</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        grid <span class="op">=</span> update(grid, <span class="fl">0.1</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>heat_equation(<span class="dv">100</span>)</span></code></pre>
</div>
<p>Line profiling demonstrates that function takes up over 55 seconds of
the total runtime, with the cost of allocating the temporary
<code>out_grid</code> list to be 39.3% of the total runtime of that
function!</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Total time: 55.4675 s
File: heat_equation.py
Function: update at line 4

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     3                                           @profile
     4                                           def update(grid, a_dt):
     5       100        127.7      1.3      0.0      x_max, y_max = grid_shape
     6       100   21822304.9 218223.0     39.3      out_grid = [[0.0 for x in range(y_max)] * y_max for x in range(x_m…
     7     51300       7741.9      0.2      0.0      for i in range(x_max):
     8  26265600    3632718.1      0.1      6.5          for j in range(y_max):
     9  26214400   11207717.9      0.4     20.2              out_xx = grid[(i-1)%x_max][j] - 2 * grid[i][j] + grid[(i+1…
    10  26214400   11163116.5      0.4     20.1              out_yy = grid[i][(j-1)%y_max] - 2 * grid[i][j] + grid[i][(…
    11  26214400    7633720.1      0.3     13.8              out_grid[i][j] = grid[i][j] + (out_xx + out_yy) * a_dt
    12       100         27.8      0.3      0.0      return out_grid</code></pre>
</div>
<p>If instead <code>out_grid</code> is double buffered, such that two
buffers are allocated outside the function, which are swapped after each
call to update().</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>grid_shape <span class="op">=</span> (<span class="dv">512</span>, <span class="dv">512</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update(grid, a_dt, out_grid):</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    x_max, y_max <span class="op">=</span> grid_shape</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(x_max):</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(y_max):</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>            out_xx <span class="op">=</span> grid[(i<span class="op">-</span><span class="dv">1</span>)<span class="op">%</span>x_max][j] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> grid[i][j] <span class="op">+</span> grid[(i<span class="op">+</span><span class="dv">1</span>)<span class="op">%</span>x_max][j]</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            out_yy <span class="op">=</span> grid[i][(j<span class="op">-</span><span class="dv">1</span>)<span class="op">%</span>y_max] <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> grid[i][j] <span class="op">+</span> grid[i][(j<span class="op">+</span><span class="dv">1</span>)<span class="op">%</span>y_max]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>            out_grid[i][j] <span class="op">=</span> grid[i][j] <span class="op">+</span> (out_xx <span class="op">+</span> out_yy) <span class="op">*</span> a_dt </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> heat_equation(steps):</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    x_max, y_max <span class="op">=</span> grid_shape</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> [[<span class="fl">0.0</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(y_max)] <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(x_max)]</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    out_grid <span class="op">=</span> [[<span class="fl">0.0</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(y_max)] <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(x_max)]  <span class="co"># Allocate a second buffer once</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Init central point to diffuse</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    grid[<span class="bu">int</span>(x_max<span class="op">/</span><span class="dv">2</span>)][<span class="bu">int</span>(y_max<span class="op">/</span><span class="dv">2</span>)] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run steps</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(steps):</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        update(grid, <span class="fl">0.1</span>, out_grid)  <span class="co"># Pass the output buffer</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        grid, out_grid <span class="op">=</span> out_grid, grid  <span class="co"># Swap buffers</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>heat_equation(<span class="dv">100</span>)</span></code></pre>
</div>
<p>The total time reduces to 34 seconds, reducing the runtime by 39%
inline with the removed allocation.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Total time: 34.0597 s
File: heat_equation.py
Function: update at line 3

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     3                                           @profile
     4                                           def update(grid, a_dt, out_grid):
     5       100         43.5      0.4      0.0      x_max, y_max = grid_shape
     6     51300       7965.8      0.2      0.0      for i in range(x_max):
     7  26265600    3569519.4      0.1     10.5          for j in range(y_max):
     8  26214400   11291491.6      0.4     33.2              out_xx = grid[(i-1)%x_max][j] - 2 * grid[i][j] + grid[(i+1…
     9  26214400   11409533.7      0.4     33.5              out_yy = grid[i][(j-1)%y_max] - 2 * grid[i][j] + grid[i][(…
    10  26214400    7781156.4      0.3     22.8              out_grid[i][j] = grid[i][j] + (out_xx + out_yy) * a_dt</code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul><li>Sequential accesses to memory (RAM or disk) will be faster than
random or scattered accesses.
<ul><li>This is not always natively possible in Python without the use of
packages such as NumPy and Pandas</li>
</ul></li>
<li>One large file is preferable to many small files.</li>
<li>Memory allocation is not free, avoiding destroying and recreating
objects can improve performance.</li>
</ul></div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="optimisation-use-latest.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="optimisation-conclusion.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="optimisation-use-latest.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Keep Python &amp;
        </a>
        <a class="chapter-link float-end" href="optimisation-conclusion.html" rel="next">
          Next: Optimisation... 
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-2">
        <a href="https://docs.hpc.shef.ac.uk/en/latest/stanage/index.html" class="external-link">
          <img alt="Stanage HPC" src="https://docs.hpc.shef.ac.uk/en/latest/_images/Stanage_Black.png" style="width: 100%;"></a>
        <p><a href="https://sites.google.com/sheffield.ac.uk/research-training/research-training" class="external-link">Research Computing Training Home</a></p>
			</div>
			<div class="col-md-5">
        <p>Lesson developed by <a href="https://rse.shef.ac.uk" class="external-link">RSE</a> &amp; <a href="https://www.sheffield.ac.uk/it-services/research" class="external-link">RIT</a></p>
        <p>
        
        <a href="https://github.com/RSE-Sheffield/pando-python/edit/main/episodes/optimisation-memory.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/RSE-Sheffield/pando-python/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a> 
        | <a href="https://github.com/RSE-Sheffield/pando-python/" class="external-link">Source</a></p>
				<p><a href="https://github.com/RSE-Sheffield/pando-python/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:robert.chisholm@sheffield.ac.uk">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
      </div>
			<div class="col-md-5">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        

        <!--<p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY 4.0</a> by <a href="https://carpentries.org/">The Carpentries</a></p>-->
        <!--<p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.2">sandpaper (0.16.2)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.3">pegboard (0.7.3)</a>, and <a href="https://github.com/RSE-Sheffield/uos-varnish/tree/main">varnish (1.0.1.9000)</a></p>-->
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.2" class="external-link">sandpaper (0.16.2)</a>,
        <a href="https://github.com/carpentries/pegboard/tree/0.7.3" class="external-link">pegboard (0.7.3)</a>,
      and <a href="https://github.com/RSE-Sheffield/uos-varnish/tree/main" class="external-link">varnish (1.0.1.9000) [UoS fork]</a>.</p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "rse.shef.ac.uk/pando-python/optimisation-memory.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "python, profiling, optimisation, data structures, algorithms",
  "name": "Understanding Memory",
  "creativeWorkStatus": "active",
  "url": "rse.shef.ac.uk/pando-python/optimisation-memory.html",
  "identifier": "rse.shef.ac.uk/pando-python/optimisation-memory.html",
  "dateCreated": "2024-02-15",
  "dateModified": "2024-02-08",
  "datePublished": "2024-02-15"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

